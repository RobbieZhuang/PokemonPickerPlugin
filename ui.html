<style>
  .window { height: auto; width: auto; display: flex; justify-content: center;
  align-items: center; flex-direction:column}
  #searchBar, #results, #insertChewtle {
    margin: 5px;
  }
  #results {
    display: grid; grid-template-columns: auto auto auto; grid-gap: 10px;
  }
  .thumbnail {height: auto; width: 140px;}
</style>
<div class="window">
  <div id="searchBar">
    <input type="text" id="pokemonQuery">
    <input type="submit" id="searchButton" value="Search">
    <label id="searchStatus"></label>
  </div>
  <div id="results"></div>
  <!-- <p>Count: <input id="count" type="number" value="5"></p> -->
  <button id="insertChewtle">Insert Grass Energy</button>
  <!-- <button id="cancel">Cancel</button> -->
</div>
<script>

document.getElementById('pokemonQuery').onkeyup = async (k) => {
  if (k.keyCode === 13) {
    await searchCards()
  }
}

document.getElementById('searchButton').onclick = async () => {
  await searchCards()
}

document.getElementById('insertChewtle').onclick = async () => {
  await insertChewtle();
}

async function searchCards() {
  const response = await fetch(
    'https://api.pokemontcg.io/v2/cards?q=name:' + document.getElementById('pokemonQuery').value, 
    {method: 'GET'}
  );
  const data = await response.json();
  
  const resultsDiv = document.getElementById('results');
  const searchStatus = document.getElementById('searchStatus');
  console.log(data);
  console.log(data.data.length);
  const numberOfCards = data.data.length;
  var cardsLoaded = 0
  searchStatus.innerHTML = cardsLoaded + '/' + numberOfCards + ' loaded'

  for (card in data.data) {
    const cardId = data.data[card].id
    const thumbnail = document.createElement("img");
    thumbnail.className = "thumbnail"
    thumbnail.src = await getCardImageSmall(cardId)

    thumbnail.onmouseenter = () => {
      thumbnail.style.opacity = 0.7
    }
    thumbnail.onmouseleave = () => {
      thumbnail.style.opacity = 1.0
    }
    
    thumbnail.onclick = async () => {
      const response = await fetch('https://api.pokemontcg.io/v2/cards/' + cardId, {method: 'GET'});
      const data = await response.json();
      const imageResponse = await fetch(data.data.images.large, {});
      const image = await new Response(imageResponse.body).arrayBuffer();
      window.parent.postMessage({pluginMessage: {type: "card", data: image}}, "*");
    }
    resultsDiv.appendChild(thumbnail)
    cardsLoaded++
    searchStatus.innerHTML = cardsLoaded + '/' + numberOfCards + ' loaded'
  }
}


async function insertChewtle() {
  const image = await getCardImageHiRes('swsh45-26');
  window.parent.postMessage({pluginMessage: {type: "card", data: image}}, "*");
}

async function getCardImageSmall(cardId) {
  const response = await fetch('https://api.pokemontcg.io/v2/cards/' + cardId, {method: 'GET'});
  const data = await response.json();
  const imageResponse = await fetch(data.data.images.small, {});
  const imageBlob = await imageResponse.blob();
  return URL.createObjectURL(imageBlob);
}

async function getCardImageHiRes(cardId) {
  const response = await fetch('https://api.pokemontcg.io/v2/cards/' + cardId, {method: 'GET'});
  const data = await response.json();
  const imageResponse = await fetch(data.data.images.large, {});
  return await new Response(imageResponse.body).arrayBuffer();
}

</script>
