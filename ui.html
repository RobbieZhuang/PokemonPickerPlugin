<div style="height: 500px;">
  <h2>Pokemon Picker</h2>
  <input type="text" id="pokemonQuery">
  <input type="submit" id="searchButton" value="Search">
  <div id="results"></div>
  <!-- <p>Count: <input id="count" type="number" value="5"></p> -->
  <br></br>
  <button id="insert">Insert Grass Energy</button>
  <!-- <button id="cancel">Cancel</button> -->
</div>

<script>
document.getElementById('searchButton').onclick = async () => {
  const response = await fetch(
    'https://api.pokemontcg.io/v2/cards?q=name:' + document.getElementById('pokemonQuery').value, 
    {method: 'GET'}
  );
  const data = await response.json();
  console.log(data);
  const resultsDiv = document.getElementById('results');
  for (card in data.data) {
    const newResult = document.createElement("input")
    newResult.className = "cardResult"
    newResult.type = "submit"
    newResult.value = data.data[card].id
    newResult.onclick = async () => {
      console.log("clicked!");
      console.log(newResult.value)
      const response = await fetch('https://api.pokemontcg.io/v2/cards/' + newResult.value, {method: 'GET'});
      const data = await response.json();
      const imageResponse = await fetch(data.data.images.large, {});
      const image = await new Response(imageResponse.body).arrayBuffer();
      window.parent.postMessage({pluginMessage: {type: "card", data: image}}, "*");
    }
    resultsDiv.appendChild(newResult)
  }
}


document.getElementById('insert').onclick = async () => {
  // const textbox = document.getElementById('count');
  // const count = parseInt(textbox.value, 10);

  const response = await fetch('https://api.pokemontcg.io/v2/cards/swsh45-26', {method: 'GET'});
  const data = await response.json();
  const imageResponse = await fetch(data.data.images.large, {});
  const image = await new Response(imageResponse.body).arrayBuffer();
  window.parent.postMessage({pluginMessage: {type: "card", data: image}}, "*");
  // var request = new XMLHttpRequest();
  // request.open('GET', 'https://api.pokemontcg.io/v2/cards/base1-13');
  // request.responseType = "json";
  // console.log("gonna send req")
  // request.onload = () => {
  //   console.log("got response")
  //   // const imageUrl = request.response.data.images.large;

  //   // const image = await fetch(imageUrl);
  //   // const imageBuffer = await image.arrayBuffer();
  //   // const imageArray = Uint8Array(imageBuffer);
  //   window.parent.postMessage({pluginMessage: {type: "card", data: imageArray}}, "*");
  // }
  // request.send();
  // parent.postMessage({ pluginMessage: { type: 'create-shapes', count } }, '*')
}

document.getElementById('cancel').onclick = () => {
  parent.postMessage({ pluginMessage: { type: 'cancel' } }, '*')
}

</script>
