<style>
  .window {
    height: auto;
    width: auto;
    display: flex;
    justify-content: center;
    align-items: center;
    flex-direction: column;
  }
  #searchBar,
  #results,
  #insertChewtle {
    margin: 5px;
  }
  #results {
    display: grid;
    grid-template-columns: auto auto auto;
    grid-gap: 10px;
  }
  .thumbnail {
    height: auto;
    width: 140px;
  }
</style>
<div class="window">
  <div id="searchBar">
    <input type="text" id="pokemonQuery" />
    <input type="submit" id="searchButton" value="Search" />
    <label id="searchStatus"></label>
  </div>
  <div id="results"></div>
  <!-- <p>Count: <input id="count" type="number" value="5"></p> -->
  <button id="insertChewtle">Insert Grass Energy</button>
  <!-- <button id="cancel">Cancel</button> -->
</div>
<script>
  document.getElementById("pokemonQuery").focus();

  document.getElementById("pokemonQuery").onkeyup = async (k) => {
    if (k.keyCode === 13) {
      await searchCards();
    }
  };

  document.getElementById("searchButton").onclick = async () => {
    await searchCards();
  };

  document.getElementById("insertChewtle").onclick = async () => {
    await insertChewtle();
  };

  async function searchCards() {
    const response = await fetch(
      "https://api.pokemontcg.io/v2/cards?q=name:" +
        document.getElementById("pokemonQuery").value,
      { method: "GET" }
    );
    const data = await response.json();
    console.log(response);

    const resultsDiv = document.getElementById("results");
    const searchStatus = document.getElementById("searchStatus");

    const numberOfCards = data.data.length;
    var cardsLoaded = 0;
    searchStatus.innerHTML = cardsLoaded + "/" + numberOfCards + " loaded";

    for (card in data.data) {
      const cardId = data.data[card].id;
      const cardImage = await getCardImageSmall(cardId);
      const thumbnail = document.createElement("img");
      thumbnail.className = "thumbnail";
      thumbnail.src = cardImage;

      thumbnail.onmouseenter = () => {
        thumbnail.style.opacity = 0.7;
      };
      thumbnail.onmouseleave = () => {
        thumbnail.style.opacity = 1.0;
      };

      thumbnail.onclick = async (e) => {
        window.parent.postMessage(
          {
            pluginMessage: {
              type: "card",
              data: await getCardImageHiRes(cardId),
            },
          },
          "*"
        );
      };

      var pointer = [];
      var cardSize = [];
      var canvasCardSize = [];
      // preceivedSize = canvasCardSize / cardSize * zoomLevel
      var preceivedZoom = 0; // This is how much we want to scale the dragged icon by
      var zoomLevel = 0;
      thumbnail.ondragstart = async (e) => {
        const rect = e.target.getBoundingClientRect();
        pointer = [e.clientX - rect.left, e.clientY - rect.top];
        cardSize = [rect.width, rect.height];
        // Get current zoom level on the screen
        window.parent.postMessage(
          { pluginMessage: { type: "zoomRequest" } },
          "*"
        );
      };

      onmessage = (event) => {
        const message = event.data.pluginMessage;
        zoomLevel = message.zoom;
        canvasCardSize = message.size;
        preceivedZoom = (canvasCardSize[0] / cardSize[0]) * zoomLevel;
      };

      thumbnail.ondragend = async (e) => {
        window.parent.postMessage(
          {
            pluginMessage: {
              type: "cardDrag",
              data: await getCardImageHiRes(cardId),
              pos: [e.pageX, e.pageY],
              pointer: pointer,
            },
          },
          "*"
        );
        // window.parent.postMessage({pluginMessage: {type: "cardDrag", data: await getCardImageHiRes(cardId)}, pos: [e.offsetX - 250, e.offsetY - 250]}, "*");
      };
      resultsDiv.appendChild(thumbnail);
      cardsLoaded++;
      searchStatus.innerHTML = cardsLoaded + "/" + numberOfCards + " loaded";
    }
  }

  async function insertChewtle() {
    const image = await getCardImageHiRes("swsh45-26");
    window.parent.postMessage(
      { pluginMessage: { type: "card", data: image } },
      "*"
    );
  }

  async function getCardImageSmall(cardId) {
    const response = await fetch(
      "https://api.pokemontcg.io/v2/cards/" + cardId,
      { method: "GET" }
    );
    const data = await response.json();
    const imageResponse = await fetch(data.data.images.small, {});
    const imageBlob = await imageResponse.blob();
    return URL.createObjectURL(imageBlob);
  }

  async function getCardImageHiRes(cardId) {
    const response = await fetch(
      "https://api.pokemontcg.io/v2/cards/" + cardId,
      { method: "GET" }
    );
    const data = await response.json();
    const imageResponse = await fetch(data.data.images.large, {});
    return await new Response(imageResponse.body).arrayBuffer();
  }
</script>
